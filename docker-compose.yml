version: '3.8'

services:
  rvc2mqtt:
    # Use pre-built image from GitHub Container Registry (recommended)
    image: ghcr.io/rv10guy/rvc2mqtt:latest

    # OR: Build locally (uncomment to build from source)
    # build:
    #   context: .
    #   dockerfile: Dockerfile

    container_name: rvc2mqtt

    # Use host network mode for simplest configuration
    # This allows direct access to ESP32 SLCAN and MQTT broker
    network_mode: host

    # Restart policy
    restart: unless-stopped

    # Environment variables
    environment:
      - TZ=America/New_York       # Set your timezone
      # Optionally override config via environment variables
      # - DEBUG_LEVEL=1
      # - MQTT_BROKER=192.168.50.77
      # - MQTT_USER=hassio
      # - MQTT_PASS=hassio

    # Volume mounts
    volumes:
      # Configuration file (read-only)
      - ./rvc2mqtt.ini:/app/rvc2mqtt.ini:ro

      # Mappings directory (read-only)
      - ./mappings:/app/mappings:ro

      # RVC spec file (read-only)
      - ./rvc-spec.yml:/app/rvc-spec.yml:ro

      # Logs directory (read-write for persistence)
      - ./logs:/app/logs

      # Audit logs directory (read-write for persistence)
      - ./audit:/app/audit

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "rvc2mqtt.py"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Notes:
# - Uses pre-built image from ghcr.io (automatic builds via GitHub Actions)
# - Host network mode is recommended for simplest setup
# - All configuration files are volume mounted from host
# - Logs persist across container restarts
#
# Commands:
# - Pull latest image: docker-compose pull
# - Start: docker-compose up -d
# - Stop: docker-compose down
# - View logs: docker-compose logs -f
# - Update to latest: docker-compose pull && docker-compose up -d
#
# To build locally instead:
# - Uncomment the 'build' section above
# - Comment out the 'image: ghcr.io/...' line
# - Run: docker-compose up -d --build
